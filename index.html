<!DOCTYPE html>
<html>
<head>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.7.0/nouislider.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/noUiSlider/14.7.0/nouislider.min.css">
    <link rel="stylesheet" href="css/style.css">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        .container {
            width: 500px;
            margin: 0 auto; /* Center the container horizontally */
        }
        #video-controls {
            display: flex;
            flex-direction: column;
        }
        #output-video {
            width: 100%; /* Set the video width to 100% of its parent container */
        }
        #slider {
            width: 100%; /* Set the slider width to 100% of its parent container */
        }
        .thumbnails {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-top: 20px;
        }
        .thumbnail canvas {
            width: 40px;
            height: 30px; /* Adjust as needed */
            border: 1px solid #ccc;
        }
    </style>
</head>
<body>
<div class="container">
    <h3>Video Editor</h3>
    <div id="video-preview">
        <video id="output-video" loop autoplay playsinline controls class="hidden"></video>
    </div>
    <div id="slider"></div><br/>
    <form action="/upload" method="post" enctype="multipart/form-data" id="uploadForm">
        <div style="margin-bottom: 10px;">
            <label for="uploader">Upload Video:</label><br>
            <input type="file" name="videoFile" id="uploader">
        </div>
        <div id="timeFields" style="margin-bottom: 10px; display: none;">
            <label for="start-time">Start Time (in seconds):</label><br>
            <input type="number" id="start-time" value="0"><br>
            <label for="end-time">End Time (in seconds):</label><br>
            <input type="number" id="end-time" value="1"><br>
            <label for="duration">Duration (in seconds):</label><br>
            <span id="duration"></span><br>
        </div>
        <button type="submit" id="submitButton">Submit</button>
    </form>

    <div class="thumbnails" id="thumbnails"></div>
    
    <p id="message"></p>
</div>

<script>
    let originalFile = null;
    let videoElement = null;
    let thumbnailsContainer = null;
    let message = null;

    document.addEventListener("DOMContentLoaded", function() {
        const uploader = document.getElementById('uploader');
        videoElement = document.getElementById('output-video');
        const timeFields = document.getElementById('timeFields');
        const durationSpan = document.getElementById('duration');
        const slider = document.getElementById('slider');
        thumbnailsContainer = document.getElementById('thumbnails');
        message = document.getElementById('message');

        uploader.addEventListener('change', handleFileChange);

        function handleFileChange() {
            videoElement.classList.remove('hidden');
            const files = uploader.files;
            originalFile = files[0];
            videoElement.src = URL.createObjectURL(originalFile);

            // Show the time fields once a video is uploaded
            timeFields.style.display = 'block';

            // Get the duration of the video file
            const video = document.createElement('video');
            video.src = URL.createObjectURL(originalFile);
            video.onloadedmetadata = function() {
                const duration = video.duration;
                durationSpan.textContent = duration.toFixed(2);
                generateThumbnails(duration); // Generate thumbnails immediately
            };
        }

        async function generateThumbnails(duration) {
            try {
                message.innerHTML = 'Generating thumbnails...';
                thumbnailsContainer.innerHTML = ''; // Clear any existing thumbnails

                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');

                // Wait for the video to be loaded
                await new Promise(resolve => {
                    videoElement.onloadeddata = resolve;
                });

                canvas.width = videoElement.videoWidth;
                canvas.height = videoElement.videoHeight;

                for (let i = 0; i < 10; i++) {
                    const timestamp = (duration / 10) * i;
                    videoElement.currentTime = timestamp;
                    await new Promise(resolve => {
                        videoElement.onseeked = async () => {
                            ctx.drawImage(videoElement, 0, 0, canvas.width, canvas.height, 0, 0, 40, 30); // Adjust dimensions for thumbnail size
                            const img = document.createElement('img');
                            img.src = canvas.toDataURL('image/jpeg');
                            img.alt = `Thumbnail ${i + 1}`;
                            thumbnailsContainer.appendChild(img);
                            resolve();
                        };
                    });
                }
                message.innerHTML = 'Thumbnails generated successfully!';
            } catch (error) {
                message.innerHTML = `Error: ${error.message}`;
                console.error(error);
            }
        }
    });
</script>
</body>
</html>
