<!DOCTYPE html>
<html>
<head>
    <script src="https://cdn.jsdelivr.net/npm/@ffmpeg/ffmpeg@0.11.2/dist/ffmpeg.min.js"></script>
</head>
<body>
<div class="container">
    <h3>Thumbnail Generator</h3>
    <form action="/upload" method="post" enctype="multipart/form-data" id="uploadForm">
        <label for="uploader">Upload Video:</label><br>
        <input type="file" name="videoFile" id="uploader">
        <button type="submit" id="submitButton">Generate Thumbnails</button>
    </form>

    <div class="thumbnails" id="thumbnails"></div>
    
    <p id="message"></p>
</div>

<script>
    const { createFFmpeg, fetchFile } = FFmpeg;
    const ffmpeg = createFFmpeg({ log: true });

    document.addEventListener("DOMContentLoaded", async function() {
        const uploader = document.getElementById('uploader');
        const thumbnailsContainer = document.getElementById('thumbnails');
        const message = document.getElementById('message');

        uploader.addEventListener('change', async function() {
            const files = uploader.files;
            const originalFile = files[0];
            
            try {
                if (!ffmpeg.isLoaded()) {
                    message.innerHTML = 'Loading FFmpeg...';
                    await ffmpeg.load();
                }
                message.innerHTML = 'Generating thumbnails...';

                ffmpeg.FS('writeFile', originalFile.name, await fetchFile(originalFile));

                const numThumbnails = 30;
                const videoInfo = await ffmpeg.probe(originalFile.name);
                const duration = videoInfo.format.duration;

                const frameInterval = duration / numThumbnails;
                console.log('Frame Interval:', frameInterval);

                thumbnailsContainer.innerHTML = ''; // Clear any existing thumbnails

                for (let i = 0; i < numThumbnails; i++) {
                    const outputImageName = `thumbnail${(i + 1).toString().padStart(3, '0')}.jpg`;

                    await ffmpeg.run(
                        '-i', originalFile.name,
                        '-vf', `fps=1/${frameInterval},scale=160:90:flags=bilinear`,
                        '-vframes', '1',
                        '-an', // no audio
                        '-sn', // no subtitles
                        '-dn', // no data streams
                        outputImageName
                    );

                    const data = ffmpeg.FS('readFile', outputImageName);

                    // Create a Blob URL and display the thumbnail
                    const img = document.createElement('img');
                    img.src = URL.createObjectURL(new Blob([data.buffer], { type: 'image/jpeg' }));
                    img.alt = `Thumbnail ${i + 1}`;
                    thumbnailsContainer.appendChild(img);
                }

                message.innerHTML = 'Thumbnails generated successfully!';
            } catch (error) {
                message.innerHTML = `Error: ${error.message}`;
                console.error('Error during thumbnail generation:', error);
            }
        });
    });
</script>
</body>
</html>
